include:
  - docassemble.mlhframework:mlh_interview_framework.yml

---
modules:
  - datetime

---
# docassemble-level metadata
# See https://docassemble.org/docs/initial.html
metadata:
  title: Do-It-Yourself Letter to Landlord - Security Deposit
  short title: Letter to Landlord - Security Deposit
  subtitle: Helps you write a letter to your former landlord to get your security deposit back.
  authors:
    - Bianca Stella Bruschi
    - Brett Harrison

---
# AssemblyLine-level metadata
mandatory: True
variable name: interview_metadata["main_interview_key"]
data:
  #title: Do-It-Yourself Letter to Landlord (Security Deposit) (AL)
  #short title: Letter to Landlord - Security Deposit (AL)
  description: |
    This tool helps someone in Michigan write a letter to a landlord to get their security deposit returned to them.
  allowed courts: []
  categories: []
  typical role: "plaintiff"
  generate download screen: True

---
sections:
  - section_intro: Introduction
  - section_tenant: Tenant Information
  - section_rental: Rental Information
  - section_landlord: Landlord Information
  - section_done: Success

---
id: interview config code block
code: |
  # interview_metadata['main_interview_key'] = 'letter_to_landlord_security'
  github_repo_name =  'docassemble-MichiganLetterToLandlordReRet'
  al_form_type = "letter"
  MLH_instructions_included = True
  MLH_form_type = "letter"
  MLH_court_forms = False
  MLH_time_min = 5
  MLH_time_max = 20

---
objects:
  - forwarding_address: ALAddress
  - rental_address: ALAddress
  - other_parties: ALPeopleList.using(ask_number=True,target_number=1)
  - users: ALPeopleList.using(there_are_any=True)

---
# # # # # # # # # # # # # # Interview Order # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # Interview Order # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # Interview Order # # # # # # # # # # # # # # # #
comment: |
  Controls order and branching logic for questions specific to this form
id: interview order letter to landlord security deposit
mandatory: True
code: |
  allowed_courts = interview_metadata["main_interview_key"]["allowed courts"]
  nav.set_section("section_intro")
  user_role = "plaintiff"
  user_ask_role = "plaintiff"
  
  MLH_standard_intro_pages
  intro_what_you_need
  nav.set_section("section_tenant")

  vacation_date
  if (vacation_date + timedelta(days=30) > today()):
    thirty_days_not_passed

  notification_date
  if vacation_date + timedelta(days=4) < notification_date:
    late_forwarding_kickout

  if any_deposit_returned:
    deposit_returned_kickout
  users.gather()
  users[0].phone_number
  users[0].phone_number = phone_number_formatted(users[0].phone_number)
  set_parts(subtitle=str(users))
  forwarding_address.address

  nav.set_section("section_rental")
  rental_address.address
  type_of_delivery
  deposit_amount

  nav.set_section("section_landlord")
  other_parties.gather()
  other_parties[0].address.address
  other_parties[0].phone_number
  if type_of_delivery == "e-mailed":
    other_parties[0].email

  nav.set_section("section_done")
  interview_order_letter_to_landlord_security = True
  MLH_outro_saving_answers
  if (vacation_date + timedelta(days=30) > today()):
    letter_date_notification
  MLH_outro_download_forms

  # Store anonymous data for analytics / statistics
  store_variables_snapshot(
      persistent=True,
      data={
          "zip": showifdef("users[0].address.zip"),
          "reached_interview_end": True,
      },
  )
  download_page

# # # # # # # # # # # # # # End Interview Order # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # End Interview Order # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # End Interview Order # # # # # # # # # # # # # # # #

---
# Overrides standard landing page
id: MLH intro landing
continue button field: MLH_intro_landing
question: |
  Welcome to ${ AL_ORGANIZATION_TITLE }’s ${ MLH_interview_short_title } tool
subquestion: |
  This tool will help you write a personalized letter to your landlord requesting **return of your security deposit**.
  
  Use this tool if:
  
  * it has been more than **30 days** since you moved out of your old home,
  * you gave your previous landlord your **forwarding address** within **four days** of moving out of the home, and
  * you have **not** gotten your **security deposit** from your previous landlord.

  ${ collapse_template(forwarding_address_template) }
  
  If you did **not** give your landlord your forwarding address within four days, the timelines in this letter do not apply and **you should not use this tool**. If that is the case, click [here](https://michiganlegalhelp.org/resources/housing/security-deposit-help-tenants) to return to the Michigan Legal Help web site to learn more.
  
  Otherwise, click the **${MLH_continue_button_label}** button below.

---
# overrides standard screen
id: MLH intro time
mandatory: False
question: Using this tool
subquestion: |
  It should take you between 5 and 20 minutes to answer all the questions.
  
  Your personalized letter will be ready to print after you have answered all the questions. 
  
  % if MLH_instructions_included:
    You will also get a set of step-by-step instructions on what to do next with your letter.
  % endif
continue button field: MLH_intro_time

---
id: intro what you need
continue button field: intro_what_you_need
question: |
  Getting ready
subquestion: |
  You need to have this information at hand to complete the tool: 
  
  * Your **contact** information (forwarding address, phone number, e-mail etc.);
  * If **your roommates or co-tenants** are signing this letter with you, you should have their **contact** information ready (name, address, phone number);
  * Your **landlord**'s name and **contact** information (name, address, phone number);
  * The **rental** address you moved out from;
  * The **amount** of the deposit; 

---
id: thirty days not passed
continue button field: thirty_days_not_passed
question: It has not been 30 days
subquestion: |
  This letter should only be used if you moved out more than 30 days ago.

  You can still use this tool now to create your letter, but **wait to send the letter until 30 days have gone by and your landlord has still not returned your security deposit or given you a list of damages.** 
  
  This means that you should not send your letter before ${ letter_date }.

---
template: forwarding_address_template
subject: |
  What is a forwarding address?
content: |
  Within **four days** of moving out of your old home, you must give your landlord your **new address** in writing. If you don’t want to give your landlord your new address, you can provide a different forwarding address like a P.O. Box. If you do this, make sure you **regularly pick up** any mail sent to that address.

---
mandatory: True
id: late forwarding kickout
event: late_forwarding_kickout
question: |
  You cannot use this tool
subquestion: |
  You must notify your landlord in writing within four days after you move of a forwarding address where you can be reached and where you will receive mail. If you don’t provide your new address, your landlord does not have to give you an itemized list of damages and they can keep your security deposit until you do something to get it back.

  To learn more, please read [Your Security Deposit: What It Is and How to Get It Back](https://michiganlegalhelp.org/resources/housing/your-security-deposit-what-it-and-how-get-it-back).
  
  ${ action_button_html("https://michiganlegalhelp.org/resources/housing/your-security-deposit-what-it-and-how-get-it-back", label="Exit", color="danger", size="md") }

---
id: any deposit returned
question: Has your landlord returned your security deposit or given you an itemized list of damages?
fields:
  - no label: any_deposit_returned
    datatype: yesnoradio
---
id: deposit returned kickout
event: deposit_returned_kickout
question: |
  You cannot use this tool
subquestion: |
  This letter should only be used if your landlord has not returned your security deposit or given you an itemized list of damages for why they have kept some or all of your security deposit. 
  
  If you got an itemized list of damages, you have 7 days to respond. To learn more, please read [Your Security Deposit: What It Is and How to Get It Back](https://michiganlegalhelp.org/resources/housing/your-security-deposit-what-it-and-how-get-it-back).
  
  ${ action_button_html("https://michiganlegalhelp.org/resources/housing/your-security-deposit-what-it-and-how-get-it-back", label="Exit", color="danger", size="md") }

---
id: phone number
question: |
  What is your phone number?
subquestion: |
  It is important that your landlord have another way of reaching out to you other than sending mail to your forwarding address.
  % if False:
  ${ collapse_template(phone_info_template) }
  % endif
fields:  
  - Phone number: users[0].phone_number

---
template: phone_info_template
subject: |
  Why do I need to give my phone number?
content: |
  It is important that your landlord have another way of reaching out to you other than sending mail to your forwarding address. 

---
code: |
  def one_ones() -> str:
    if len(users.elements) > 1:
      return "ones"
    else:
      return "one"

---
id: any other users
question: |
  Are there any other tenants?
subquestion: |
  **If you are not the only ${ one_ones() }** trying to get your security deposit back, add the **names** of your old co-tenants who are interested in getting it back as well. Only adults who signed the lease or who were part of the rental agreement should be included in this letter.

  % if len(users.elements) > 1:
  **Other than ${comma_and_list(users.complete_elements())}, are there any other tenants on the lease who should also be included in this letter?**
  % else:
  **Are there any other tenants on the lease who should also be included in this letter?**
  % endif
fields:
  - no label: users.there_is_another
    datatype: yesnoradio

---
sets:
  - users[i].name.first
  - users[i].name.last
  - users[i].name.middle
  - users[i].name.suffix
id: other users names
question: |
  ${ capitalize(ordinal_number(i)) } other tenant
subquestion: |
  % if al_form_type in ['starts_case','existing_case','appeal']:
  Who is the ${ ordinal(i) } person on your side of the case?
  % else:
  What is the name of the ${ ordinal_number(i) } other person who is adding their name to 
  this letter with you?
  % endif
  % if len(users.elements) > 2:
  *So far you have told us about ${comma_and_list(users.complete_elements())}.*
  % endif
fields:
  - code: |
      users[i].name_fields()

---
id: forwarding address
sets:
  - forwarding_address.address
  - forwarding_address.city
  - forwarding_address.zip
  - forwarding_address.unit
  - forwarding_address.state
  - forwarding_address.country
question: |
  What is the forwarding address you gave to your landlord?
subquestion: |
  Insert your forwarding address below, as given to your landlord.
  
  ${ collapse_template(forwarding_address_template) }
  
fields:
  - code: |
      forwarding_address.address_fields(country_code=AL_DEFAULT_COUNTRY, default_state=AL_DEFAULT_STATE)  

---
id: When did you vacate the property
question: |
  When did you move out of the rental property?
subquestion: |
  Insert the date manually, or choose it from the drop-down calendar by clicking on the <i class="fa-regular fa-calendar"></i> calendar icon.
fields:
  - "Move-out date": vacation_date
    datatype: date

---
id: notification date
question: |
  When did you tell your landlord your forwarding address?
subquestion: |
  ${ collapse_template(forwarding_address_template) }
  
  Insert the date manually, or choose it from the drop-down calendar by clicking on the <i class="fa-regular fa-calendar"></i> calendar icon.
fields:
  - "Date of Notification": notification_date
    datatype: date

---
id: notification method
question: |
  How did you tell your landlord your forwarding address?
#subquestion: |
#  Choose one of the three options.
fields:
  - no label: type_of_delivery
    input type: radio
    choices:
      - Hand-delivered: hand-delivered
      - Mailed: mailed
      - E-mailed: e-mailed

---
id: rental address
sets:
  - rental_address.address
  - rental_address.city
  - rental_address.zip
  - rental_address.unit
  - rental_address.state
  - rental_address.country
question: |
  What is the address of the rental property you moved out from?
fields:
  - code: |
      rental_address.address_fields(country_code=AL_DEFAULT_COUNTRY, default_state=AL_DEFAULT_STATE)  

---
id: How much was the deposit
question: |
  How much was the deposit?
subquestion: |
  If you don't know, look at your lease and any receipts you have from when you moved into the apartment.
fields:
  - "Deposit amount": deposit_amount
    datatype: currency
    min: 0

---
# to override "Is this a person, or a business?" in ql_baseline.yml
# TODO - is there an easier way to override just the prompt?
generic object: ALIndividual
template: x.person_type_label
content: ""

---
sets:
  - other_parties[i].name.first
  - other_parties[i].name.last
  - other_parties[i].name.middle
  - other_parties[i].name.suffix
id: type of landlord
question: |
  Is your landlord a person or a business?
fields:
  - code: |
      other_parties[i].name_fields(person_or_business='unsure')

---
template: landlord_address_template
subject: What if my landlord's address has changed?
content: |
  You should send or deliver the letter to the address you landlord gave you in the lease. If your landlord's address has changed since then, you should have gotten notice of it in writing. If you know your landlord's new address, send the letter to that address.

---
sets:
  - x.address.address
  - x.address.city
  - x.address.zip
  - x.address.unit
  - x.address.state
  - x.address.country
id: persons address
generic object: ALIndividual
question: |
  What is ${ x.possessive('address') }?
subquestion:
  ${ collapse_template(landlord_address_template) }
fields:
  - code: |
      x.address_fields(country_code=AL_DEFAULT_COUNTRY, default_state=AL_DEFAULT_STATE)

---
id: letter date
question: Don't send your letter yet!
subquestion: |
  Because it has not been 30 days since you moved out, the date shown on your letter will be ${ letter_date }. **Do not send your letter before that date!**
continue button field: letter_date_notification

---
reconsider: True
code: |
  if (vacation_date + timedelta(days=30) > today()):
    letter_date = vacation_date + timedelta(days=30)
  else:
    letter_date = today()

---
# Overrides framework question
id: MLH outro download forms
mandatory: false
question: |
  Download Your ${ MLH_form_type.capitalize() }
  % if MLH_instructions_included:
   and Instructions 
  % endif
subquestion: |
  On the next page, there will be a list of files. The top file is a set of step-by-step instructions to tell you what to do next. 
  
  The other file is the letter that you will need to send to ${ other_parties[0].name.full() } after it is signed.

  Be sure to review your ${ MLH_form_type } to make sure all of the information is correct.
  
  For more information about your legal problem, see the [Tenant's Rights Resource page](https://michiganlegalhelp.org/resources/tenants-rights) of michiganlegalhelp.org.
continue button field: MLH_outro_download_forms

---
# Used in template to dynamically insert "I" vs "We" for example
reconsider: True
code: |
  num_tenants = len(users.elements)
  if num_tenants == 1:
    I_we = "I"
    my_our = "my"
    me_us = "me"
  else:
    I_we = "we"
    my_our = "our"
    me_us = "us"

---
id: preview letter_to_landlord_security
question: |
  Preview your form before you sign it
subquestion: |
  Here is a preview of the form you will sign on the next page.   
  
  ${ al_recipient_bundle.as_pdf(key='preview') }

  Click the image to open it in a new tab. Click the **Edit answers** button
  to edit your answers.

  ${ action_button_html(url_action('review_letter_to_landlord_security'), label='Edit answers', color='info') }
  
  Remember to come back to this window to continue and sign your form.
continue button field: letter_to_landlord_security_preview_question    

---
code: |
  signature_fields = []



# # # # # # # # # # # # # Review Pages # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # Review Pages # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # Review Pages # # # # # # # # # # # # # # # #

---
id: letter to landlord review screen
event: review_letter_to_landlord_security
question: |
  Review your answers
subquestion: |
  Click the **Edit** button in any section to make changes. Click the blue **Resume** button at the bottom if you are done.
review:
  - Edit: users.revisit
    button: |
      **Tenants**

      % for item in users:
        * ${ item }
      % endfor

  - Edit: forwarding_address.address
    button: |
      **Forwarding Address**

      ${ forwarding_address }
  - Edit: other_parties.revisit
    button: |
      **Landlord Information**

      % for item in other_parties:
        * ${ item }

          ${ item.address.on_one_line() }
      % endfor
  - Edit: deposit_amount
    button: |
      **Deposit Amount**:
      ${ currency(deposit_amount) }
  - Edit: type_of_delivery
    button: |
      **Type of Delivery**:
      ${ type_of_delivery }
  - Edit: rental_address.address
    button: |
      **Rental Address**:

      ${ rental_address }
  - Edit: vacation_date
    button: |
      **Move-out Date**:
      ${ vacation_date }
  - Edit: notification_date
    button: |
      **Date of Notification**:
      ${ notification_date }

---
continue button field: users.revisit
question: |
  Edit Tenants
subquestion: |
  ${ users.table }

  ${ users.add_action() }
---
table: users.table
rows: users
columns:
  - Name: |
      row_item.name.full() if defined("row_item.name.first") else ""
  - Phone number: |
      phone_number_formatted(row_item.phone_number) if defined("row_item.phone_number") else ""
edit:
  - name.first
  - phone_number
confirm: True

---
continue button field: other_parties.revisit
question: |
  Edit Landlord Information
subquestion: |
  ${ other_parties.table }

  #${ other_parties.add_action() }
---
table: other_parties.table
rows: other_parties
columns:
  - Name: |
      row_item.name.full() if defined("row_item.name.first") else ""
  - Address: |
      row_item.address.block() if defined("row_item.address.address") else ""
  - Phone number: |
      phone_number_formatted(row_item.phone_number) if defined("row_item.phone_number") else ""
edit:
  - name.first
  - address.address
  - phone_number
confirm: True

---
# # # # # # # # # # # # # # Documents # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # Documents # # # # # # # # # # # # # # # #
# # # # # # # # # # # # # # Documents # # # # # # # # # # # # # # # #

id: download letter_to_landlord_security
event: download_page
question: |
  All done
subquestion: |
  Thank you ${users[0].name.first}. Your letter is ready to download and deliver.
  
  You can view and download your letter below. Click the **Edit answers** button to make changes or fix any mistakes.

  ${ action_button_html(url_action('review_letter_to_landlord_security'), label='Edit answers', color='info') }
  
  
  ${ al_user_bundle.download_list_html() }
  
  ${ al_user_bundle.send_button_html(show_editable_checkbox=True) }

#progress: 100

---
generic object: ALDocumentBundle
template: x.include_editable_documents
content: |
  Include an editable copy


---
# ALDocument objects specify the metadata for each template
objects:
  - letter_to_landlord_security_Post_interview_instructions: ALDocument.using(title="Instructions", filename="letter_to_landlord_security_next_steps.docx", enabled=True, has_addendum=False)
  - letter_to_landlord_security_attachment: ALDocument.using(title=MLH_interview_title, filename="letter_to_landlord_security", enabled=True, has_addendum=False)

---
# Bundles group the ALDocuments into separate downloads, such as for court and for the user
objects:
  - al_user_bundle: ALDocumentBundle.using(elements=[letter_to_landlord_security_Post_interview_instructions, letter_to_landlord_security_attachment], filename="letter_to_landlord_security", title="All forms to download for your records", enabled=True)
  - al_recipient_bundle: ALDocumentBundle.using(elements=[letter_to_landlord_security_attachment],  filename="letter_to_landlord_security", title="All forms to file", enabled=True)

---
# Each attachment defines a key in an ALDocument. We use `i` as the placeholder here so the same
# template is used for "preview" and "final" keys, and logic in the template checks the value of 
# `i` to show or hide the user's signature
attachment:
  name: Post-interview-Instructions
  filename: letter_to_landlord_security_next_steps
  variable name: letter_to_landlord_security_Post_interview_instructions[i]
  docx template file: letter_to_landlord_security_next_steps.docx
  skip undefined: False

---
attachment:
  name: letter to landlord
  filename: letter_to_landlord_security
  variable name: letter_to_landlord_security_attachment[i]
  docx template file: letter_to_landlord_security.docx
  skip undefined: False
